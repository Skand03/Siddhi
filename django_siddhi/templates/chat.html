{% extends 'base.html' %}

{% block title %}Chat - Siddhi{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Header -->
        <div class="gradient-bg text-white p-6">
            <h2 class="text-2xl font-bold">üí¨ Chat Discussion</h2>
            <p class="text-sm opacity-90">Have a natural conversation with AI</p>
        </div>

        <!-- Prompt Bar -->
        <div id="promptBar" class="bg-gray-50 border-b p-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2">‚úèÔ∏è Customize Your Prompt</label>
                <textarea id="customPrompt" 
                          class="w-full h-32 p-4 border rounded-lg resize-y"
                          placeholder="Enter your custom prompt...">Let's have a natural conversation about this text. Start by introducing what we're discussing, then I can help you with:

‚Ä¢ Understanding and clarifying the content
‚Ä¢ Explaining complex concepts
‚Ä¢ Analyzing themes and arguments
‚Ä¢ Generating ideas and solutions
‚Ä¢ Providing additional information
‚Ä¢ Answering your questions

Begin the conversation naturally and wait for my questions.

Text to discuss:

</textarea>
            </div>
            <div class="mb-4">
                <label class="block font-semibold mb-2">üìù Selected Text (Optional)</label>
                <textarea id="selectedText" 
                          class="w-full h-24 p-4 border rounded-lg resize-y"
                          placeholder="Paste text you want to discuss..."></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="startChat()" 
                        class="flex-1 gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    Start Chat
                </button>
                <button onclick="skipPrompt()" 
                        class="px-6 py-3 border rounded-lg hover:bg-gray-100 transition">
                    Skip
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="h-96 overflow-y-auto p-6 space-y-4 hidden">
            <!-- Messages will be added here -->
        </div>

        <!-- Chat Input -->
        <div id="chatInput" class="border-t p-6 hidden">
            <div class="flex gap-3">
                <input type="text" 
                       id="messageInput" 
                       class="flex-1 p-3 border rounded-lg"
                       placeholder="Type your message..."
                       onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" 
                        class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    Send
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sessionId = null;
let selectedTextGlobal = '';

function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

async function startChat() {
    const customPrompt = document.getElementById('customPrompt').value;
    const selectedText = document.getElementById('selectedText').value;
    selectedTextGlobal = selectedText;
    
    if (!customPrompt.trim()) {
        alert('Please enter a prompt');
        return;
    }
    
    sessionId = generateSessionId();
    
    // Hide prompt bar, show chat
    document.getElementById('promptBar').classList.add('hidden');
    document.getElementById('chatMessages').classList.remove('hidden');
    document.getElementById('chatInput').classList.remove('hidden');
    
    // Add loading message
    addMessage('assistant', 'Processing...', true);
    
    try {
        const response = await fetch('/api/chat/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                custom_prompt: customPrompt,
                selected_text: selectedText
            })
        });
        
        const data = await response.json();
        
        // Remove loading message
        const messages = document.getElementById('chatMessages');
        messages.removeChild(messages.lastChild);
        
        if (data.errorMessage) {
            addMessage('assistant', '‚ùå Error: ' + data.errorMessage);
        } else {
            addMessage('assistant', data.data);
        }
    } catch (error) {
        addMessage('assistant', '‚ùå Error: ' + error.message);
    }
}

function skipPrompt() {
    document.getElementById('promptBar').classList.add('hidden');
    document.getElementById('chatMessages').classList.remove('hidden');
    document.getElementById('chatInput').classList.remove('hidden');
    sessionId = generateSessionId();
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    input.value = '';
    
    // Add loading message
    addMessage('assistant', 'Thinking...', true);
    
    try {
        const response = await fetch('/api/chat/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                message: message,
                selected_text: selectedTextGlobal
            })
        });
        
        const data = await response.json();
        
        // Remove loading message
        const messages = document.getElementById('chatMessages');
        messages.removeChild(messages.lastChild);
        
        if (data.errorMessage) {
            addMessage('assistant', '‚ùå Error: ' + data.errorMessage);
        } else {
            addMessage('assistant', data.data);
        }
    } catch (error) {
        addMessage('assistant', '‚ùå Error: ' + error.message);
    }
}

function addMessage(role, content, isLoading = false) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-[80%] rounded-lg p-4 ${
        role === 'user' 
            ? 'bg-blue-500 text-white' 
            : 'bg-gray-200 text-gray-900'
    }`;
    
    if (isLoading) {
        bubble.innerHTML = '<div class="flex gap-1"><span class="animate-bounce">‚óè</span><span class="animate-bounce delay-100">‚óè</span><span class="animate-bounce delay-200">‚óè</span></div>';
    } else {
        bubble.textContent = content;
    }
    
    messageDiv.appendChild(bubble);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}
</script>
{% endblock %}
